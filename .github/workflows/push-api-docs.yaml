# When we push a new tag to the repository, open a Pull Request to synchronize
# the API reference documentation with the "docs" repository.

name: "Push API docs"

concurrency:
  group: "ci-${{ github.ref_name }}"
  cancel-in-progress: true

on:
  push:
    tags:
      - 'v*'

jobs:
  push-api-docs:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout 'fabric' repository"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0
          persist-credentials: "false"

      - name: "Checkout 'docs' repository"
        uses: "actions/checkout@v4"
        with:
          repository: "githedgehog/docs"
          path: "project_documentation"
          persist-credentials: "false"

      - name: "Copy API reference from 'fabric' to 'docs'"
        run: |
          cp docs/api.md project_documentation/docs/reference/api.md

      - name: "Generate token for the 'docs' repository"
        uses: "actions/create-github-app-token@v2"
        id: "app-token"
        with:
          app-id: "${{ secrets.APIREF_APP_ID }}"
          private-key: "${{ secrets.APIREF_PRIVATE_KEY }}"
          repositories: |
            docs

      - name: "Create Pull Request"
        uses: "peter-evans/create-pull-request@v5"
        with:
          token: "${{ steps.app-token.outputs.token }}"
          path: "project_documentation"
          commit-message: |
            Update API reference from ${{ github.repository }} tag ${{ github.ref_name }}.

            This is an automated commit created by GitHub Actions workflow,
            in the "${{ github.repository }}" repository.
          signoff: true
          title: "Update API reference from ${{ github.repository }} tag ${{ github.ref_name }}"
          body: |
            Update API reference from ${{ github.repository }} tag ${{ github.ref_name }}.

            This is an automated Pull Requesst created by GitHub Actions workflow,
            in the "${{ github.repository }}" repository.
